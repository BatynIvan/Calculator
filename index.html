<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculator</title>
  <link rel="icon" href="./img/calc_icons.png">
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <div class="calculator">

    <div class="btn_point">
      <div class="point bg_point_red"></div>
      <div class="point bg_point_yellow"></div>
      <div class="point bg_point_green"></div>
    </div>

    <div class="calc_screen" >
      <input class="result" type="text" value="0" id="res" disabled>
    </div>

    <div class="buttons">
      <div class="btn bg_btn_gray" id="ac" onclick="clearInput()">ac</div>
      <div class="btn bg_btn_gray" onclick="insert('+/-')">+/-</div>
      <div class="btn bg_btn_gray" onclick="insert('%')">%</div>
      <div class="btn bg_btn_orange" onclick="insert(' / ', true)">/</div>

      <div class="btn" onclick="insert('7')">7</div>
      <div class="btn" onclick="insert('8')">8</div>
      <div class="btn" onclick="insert('9')">9</div>
      <div class="btn bg_btn_orange" onclick="insert(' * ', true)">*</div>

      <div class="btn" onclick="insert('4')">4</div>
      <div class="btn" onclick="insert('5')">5</div>
      <div class="btn" onclick="insert('6')">6</div>
      <div class="btn bg_btn_orange" onclick="insert(' - ', true)">-</div>

      <div class="btn" onclick="insert('1')">1</div>
      <div class="btn" onclick="insert('2')">2</div>
      <div class="btn" onclick="insert('3')">3</div>
      <div class="btn bg_btn_orange" onclick="insert(' + ', true)">+</div>

      <div class="btn zero" onclick="insert('0')">0</div>
      <div class="btn" onclick="insert('.')">.</div>
      <div class="btn equal bg_btn_orange" onclick="equal()">=</div>
    </div>
  </div>
<script>

  let isLastEqual = false;
  function equal() {
    const input = document.getElementById('res').value;
    const resultNumber = input.split(/\+|\-|\*|\//);
    const [operator] = input.match(/\+|\-|\*|\//);

    const obj = {
      "+": (num1, num2) => (num1 + num2),
      "-": (num1, num2) => (num1 - num2),
      "*": (num1, num2) => Math.round((num1 * num2) * 10000)/10000,
      "/": (num1, num2) => Math.round((num1 / num2)*10000)/10000,
    }
    // FIXME: Why we need that part?
    const num1 = parseFloat(resultNumber[0]);
    const num2 = parseFloat(resultNumber[1]); 
    
    if (isNaN(num1) && isNaN(num2)) {
      alert('Your number is not valid!');
    }
    if (operator && !isNaN(num1) && !isNaN(num2) && resultNumber.length == 2) {
      document.getElementById('res').value = (obj[operator](num1, num2));
      isLastEqual = true;
    }

    if (resultNumber.length > 2) {
      const resultNumber = input.split(' '); // split by space FIXME: BAD NAMING

       for (let i = 0; i < resultNumber.length; i++) { // TODO: investigate different approach with recursion.
        // FIXME: duplicate code
        if(resultNumber.includes('*')) {
          const firstOperation = resultNumber.findIndex(item => item == '*');
          const previousNumber = Number(resultNumber[firstOperation - 1]);
          const afterNumber = Number(resultNumber[firstOperation + 1]);

          if (firstOperation && !isNaN(previousNumber) && !isNaN(afterNumber)) {
            const result = String(previousNumber * afterNumber);
            resultNumber.splice(firstOperation - 1, 3, result);
            document.getElementById('res').value = result;
          }
        }

        if (resultNumber.includes('/')) {
          const firstOperation = resultNumber.findIndex(item => item == '/');
          const previousNumber = Number(resultNumber[firstOperation - 1]);
          const afterNumber = Number(resultNumber[firstOperation + 1]);

          if (firstOperation && !isNaN(previousNumber) && !isNaN(afterNumber)) {
            const result = String(previousNumber / afterNumber);
            resultNumber.splice(firstOperation - 1, 3, result);
            document.getElementById('res').value = result;
          }
        }

        if (resultNumber.includes('-')) {
          const firstOperation = resultNumber.findIndex(item => item == '-');
          const previousNumber = Number(resultNumber[firstOperation - 1]);
          const afterNumber = Number(resultNumber[firstOperation + 1]);

          if (firstOperation && !isNaN(previousNumber) && !isNaN(afterNumber)) {
            const result = String(previousNumber - afterNumber);
            resultNumber.splice(firstOperation - 1, 3, result);
            document.getElementById('res').value = result;
          }
        }
        if (resultNumber.includes('+')) {
          const firstOperation = resultNumber.findIndex(item => item == '+');
          const previousNumber = Number(resultNumber[firstOperation - 1]);
          const afterNumber = Number(resultNumber[firstOperation + 1]);

          if (firstOperation && !isNaN(previousNumber) && !isNaN(afterNumber)) {
            const result = String(previousNumber + afterNumber);
            resultNumber.splice(firstOperation - 1, 3, result);
            document.getElementById('res').value = result;
          }
        }
      }
    }
  }


  function insert(value, notNumber) { // FIXME: avoid duplicating operators
    if (isLastEqual && !notNumber) {
      clearInput();
    }
    isLastEqual = false;
    if (value === '.') {
      document.getElementById('res').value += value;
      return;
    }
    if (document.getElementById('res').value === '0') {
      document.getElementById('res').value = value;
    }
    else {
      document.getElementById('res').value += value;
    }
  }

  function clearInput() {
    document.getElementById('res').value = '0';
  }
</script>
</body>
</html>